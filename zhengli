import os
import shutil
import re
import time
import datetime

# æºæ–‡ä»¶å¤¹
source_folder = '/Users/jinjin/PycharmProjects/PythonProject/éƒ­ç…œå‘¨'
# ç›®æ ‡æ–‡ä»¶å¤¹
destination_folder = '/Users/jinjin/PycharmProjects/PythonProject/éƒ­ç…œå‘¨'

# æ­£åˆ™åŒ¹é…è§„åˆ™ï¼šåŒ¹é… **æ–‡ä»¶åæœ€åå‡ºç°çš„ YYYY.MM.DD**
pattern = re.compile(r'(\d{4})\.(\d{2})\.(\d{2})')


def get_file_date(file_path):
    """è·å–æ–‡ä»¶åˆ›å»ºæ—¥æœŸï¼Œå¦‚æœä¸å¯ç”¨åˆ™ä½¿ç”¨ä¿®æ”¹æ—¥æœŸ"""
    if os.name == 'nt':  # Windows è·å–åˆ›å»ºæ—¶é—´
        created_time = os.path.getctime(file_path)
    else:  # Linux/macOS å¯èƒ½ä¸æ”¯æŒåˆ›å»ºæ—¶é—´ï¼Œä½¿ç”¨ `st_birthtime` æˆ–ä¿®æ”¹æ—¶é—´
        stat = os.stat(file_path)
        created_time = getattr(stat, 'st_birthtime', stat.st_mtime)

    # è½¬æ¢ä¸º YYYYMMDD æ ¼å¼
    return datetime.datetime.fromtimestamp(created_time).strftime('%Y%m%d')


def rename_file(file_path):
    """é‡å‘½åæ–‡ä»¶ä¸º 'YYYYMMDD.æ‰©å±•å'"""
    directory, filename = os.path.split(file_path)
    name, ext = os.path.splitext(filename)

    date_str = get_file_date(file_path)
    new_name = f"{date_str}{ext}"
    new_path = os.path.join(directory, new_name)

    # é¿å…é‡å
    counter = 1
    while os.path.exists(new_path):
        new_name = f"{date_str}_{counter}{ext}"
        new_path = os.path.join(directory, new_name)
        counter += 1

    os.rename(file_path, new_path)
    print(f"ğŸ“Œ é‡å‘½å: {filename} -> {new_name}")
    return new_name  # è¿”å›æ–°æ–‡ä»¶å


def classify_and_rename(directory):
    """æ‰¹é‡é‡å‘½åæ–‡ä»¶å¹¶åˆ†ç±»å­˜å‚¨"""
    for filename in os.listdir(directory):
        file_path = os.path.join(directory, filename)

        # ç¡®ä¿æ˜¯æ–‡ä»¶
        if os.path.isfile(file_path):
            matches = pattern.findall(filename)  # å…ˆå°è¯•ä»æ–‡ä»¶åä¸­åŒ¹é…æ—¥æœŸ

            if matches:
                year, month, day = matches[-1]  # å–æœ€åä¸€ä¸ªåŒ¹é…åˆ°çš„æ—¥æœŸ
            else:
                # æ–‡ä»¶åæ²¡æœ‰æ—¥æœŸä¿¡æ¯ï¼Œä½¿ç”¨åˆ›å»ºæ—¶é—´
                date_str = get_file_date(file_path)
                year, month = date_str[:4], date_str[4:6]

                # å…ˆé‡å‘½åæ–‡ä»¶
                new_filename = rename_file(file_path)
                file_path = os.path.join(directory, new_filename)  # æ›´æ–°æ–‡ä»¶è·¯å¾„
                filename = new_filename  # æ›´æ–°æ–‡ä»¶å

            # **æ£€æŸ¥å¹´ä»½å’Œæœˆä»½æ˜¯å¦åˆç†**
            if not (1900 <= int(year) <= 2100):  # é¿å…å¼‚å¸¸å¹´ä»½
                print(f"âŒ æ–‡ä»¶ {filename} çš„å¹´ä»½ {year} ä¸åœ¨åˆç†èŒƒå›´, è·³è¿‡.")
                continue

            if not (1 <= int(month) <= 12):  # é¿å…å¼‚å¸¸æœˆä»½
                print(f"âŒ æ–‡ä»¶ {filename} çš„æœˆä»½ {month} ä¸åœ¨åˆç†èŒƒå›´, è·³è¿‡.")
                continue

            print(f"âœ… åˆ†ç±»: {filename} -> {year}/{month}")

            # ç›®æ ‡ç›®å½•
            month_folder = os.path.join(destination_folder, year, month)
            os.makedirs(month_folder, exist_ok=True)  # åˆ›å»ºç›®å½•

            # ç§»åŠ¨æ–‡ä»¶
            try:
                shutil.move(file_path, os.path.join(month_folder, filename))
            except Exception as e:
                print(f"âš ï¸ ç§»åŠ¨ {filename} æ—¶å‡ºé”™: {e}")


if __name__ == "__main__":
    classify_and_rename(source_folder)
